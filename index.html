<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Vital ðŸ’Œ</title>
<style>
  /* seu css aqui (sem alteraÃ§Ãµes) */
</style>
</head>
<body>

<h1>Vital</h1>
<textarea id="mensagemInput" placeholder="Escreva sua mensagem..."></textarea>
<button onclick="enviarMensagem()">Enviar</button>

<div id="mensagensContainer"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
  // PWA Manifest Inline
  const manifestJSON = {
    "name": "Vital",
    "short_name": "Vital",
    "start_url": "./",
    "display": "standalone",
    "background_color": "#0f0f0f",
    "theme_color": "#a64ca6",
    "icons":[{"src":"https://i.imgur.com/7z1i4Hw.png","sizes":"192x192","type":"image/png"}]
  };
  const manifest = document.createElement('link');
  manifest.rel = 'manifest';
  manifest.href = URL.createObjectURL(new Blob([JSON.stringify(manifestJSON)], {type:'application/json'}));
  document.head.appendChild(manifest);

  // Service Worker Inline (offline)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
      const CACHE_NAME='vital-cache-v1';
      const urlsToCache=['./'];
      self.addEventListener('install', e => {
        e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache)));
      });
      self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
      });
    `], {type:'text/javascript'})))
    .then(() => console.log('SW Vital registrado!'));
  }

  // Firebase Config corrigida
  const firebaseConfig = {
    apiKey: "AIzaSyCdvG19MnplrrKlfZdsx6VFIsdLkTHbP3o",
    authDomain: "vital-e22d5.firebaseapp.com",
    databaseURL: "https://vital-e22d5-default-rtdb.firebaseio.com",
    projectId: "vital-e22d5",
    storageBucket: "vital-e22d5.appspot.com", // corrigido
    messagingSenderId: "76460889955",
    appId: "1:76460889955:web:8e82a93e29357d1a6ce556"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const mensagensContainer = document.getElementById('mensagensContainer');

  // REMOVIDO: firebase.database().ref().keepSynced(true);

  // PermissÃ£o NotificaÃ§Ã£o
  if ('Notification' in window) Notification.requestPermission();

  // Mensagens pendentes offline
  let filaOffline = [];

  function enviarMensagem() {
    const input = document.getElementById('mensagemInput');
    const texto = input.value.trim();
    if (!texto) return;
    const timestamp = Date.now();
    const msg = { texto, timestamp };

    if (navigator.onLine) {
      db.ref('mensagens').push(msg);
    } else {
      filaOffline.push(msg);
      mostrarMensagem(texto);
    }
    input.value = '';
  }

  window.addEventListener('online', () => {
    filaOffline.forEach(msg => db.ref('mensagens').push(msg));
    filaOffline = [];
  });

  db.ref('mensagens').on('child_added', snapshot => {
    const msg = snapshot.val();
    const agora = Date.now();
    if (msg.timestamp > agora) {
      setTimeout(() => mostrarMensagem(msg.texto), msg.timestamp - agora);
    } else {
      mostrarMensagem(msg.texto);
    }
  });

  function mostrarMensagem(texto) {
    const div = document.createElement('div');
    div.className = 'mensagem';
    div.textContent = texto;
    mensagensContainer.appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });

    if (Notification.permission === 'granted') {
      new Notification('Nova mensagem ðŸ’œ', { body: texto });
    }
  }
</script>

</body>
</html>
